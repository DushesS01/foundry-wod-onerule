// World of Darkness — 1-ки отменяют успехи + взрывы 10-ок (автомный модуль)
Hooks.once("init", () => {
  console.log("WoD: 1-ки отменяют + взрывы 10 | загружен");
});

Hooks.on("createChatMessage", async (message) => {
  const roll = message.rolls?.[0];
  if (!roll || !roll.formula) return;

  // Ищем только броски типа 5d10x10cs>=6 (включая любые цифры)
  if (!roll.formula.match(/\d+d10x10cs>=\d+/)) return;

  const diff = parseInt(roll.formula.match(/cs>=(\d+)/)?.[1]) || 6;
  let successes = roll.total || 0;

  let ones = 0;
  roll.dice.forEach(die => {
    if (die.faces === 10 && Array.isArray(die.results)) {
      ones += die.results.filter(r => r.result === 1).length;
    }
  });

  const net = Math.max(0, successes - ones);

  let resultText = "";
  if (net >= 5) resultText = `${net} успехов (ИСКЛЮЧИТЕЛЬНЫЙ!)`;
  else if (net > 0) resultText = `${net} успехов`;
  else if (ones > 0) resultText = "БОТЧ!";
  else resultText = "Провал";

  const newFlavor = `${message.flavor || ""}<br>Чистый результат: <b>${resultText}</b> (сложность ${diff}, −${ones} единиц)`;

  await message.update({ flavor: newFlavor }, { diffData: false });
});